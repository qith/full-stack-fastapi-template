# PMinfo 系统快速部署命令（IP+端口访问）

## 一键部署命令（复制粘贴执行）

```bash
# ============================================
# 1. 安装 Docker 和 Docker Compose
# ============================================

# Ubuntu/Debian 系统
sudo apt update && sudo apt upgrade -y
sudo apt-get install -y ca-certificates curl gnupg lsb-release
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
sudo docker --version && sudo docker compose version

# CentOS/RHEL 系统
# sudo yum install -y yum-utils
# sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
# sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
# sudo systemctl start docker && sudo systemctl enable docker
# sudo docker --version && sudo docker compose version

# ============================================
# 2. 准备项目目录
# ============================================

mkdir -p /root/code && cd /root/code

# 方法1: 使用Git克隆（如果有仓库）
# git clone your-repository-url pminfo
# cd pminfo

# 方法2: 如果项目已上传，直接进入目录
# cd /root/code/pminfo

# ============================================
# 3. 获取服务器IP并创建.env文件
# ============================================

# 获取服务器IP
SERVER_IP=$(hostname -I | awk '{print $1}')
if [ -z "$SERVER_IP" ]; then
    SERVER_IP=$(ip addr show | grep -oP 'inet \K[\d.]+' | grep -v '127.0.0.1' | head -1)
fi
echo "服务器IP: $SERVER_IP"

# 生成密钥
SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_urlsafe(32))" 2>/dev/null || openssl rand -base64 32)
DB_PASSWORD=$(python3 -c "import secrets; print(secrets.token_urlsafe(32))" 2>/dev/null || openssl rand -base64 32)

# 创建.env文件（请修改管理员邮箱和密码）
cat > .env << EOF
ENVIRONMENT=production
DOMAIN=localhost
STACK_NAME=pminfo
PROJECT_NAME=PMinfo
DOCKER_IMAGE_BACKEND=pminfo-backend
DOCKER_IMAGE_FRONTEND=pminfo-frontend
TAG=latest
PUBLIC_HOST=${SERVER_IP}
FRONTEND_HOST=http://${SERVER_IP}:8880
BACKEND_CORS_ORIGINS=["http://${SERVER_IP}:8880"]
SECRET_KEY=${SECRET_KEY}
FIRST_SUPERUSER=admin@example.com
FIRST_SUPERUSER_PASSWORD=changethis
POSTGRES_SERVER=db
POSTGRES_PORT=5432
POSTGRES_USER=app
POSTGRES_PASSWORD=${DB_PASSWORD}
POSTGRES_DB=app
SMTP_HOST=
SMTP_USER=
SMTP_PASSWORD=
SMTP_PORT=587
SMTP_TLS=true
EMAILS_FROM_EMAIL=noreply@example.com
SENTRY_DSN=
EOF

# 编辑.env文件，修改管理员邮箱和密码（重要！）
echo "请编辑 .env 文件，修改 FIRST_SUPERUSER 和 FIRST_SUPERUSER_PASSWORD"
nano .env
# 或者使用 vi: vi .env

# ============================================
# 4. 开放防火墙端口（如果需要）
# ============================================

# Ubuntu/Debian (UFW)
sudo ufw allow 8880/tcp
sudo ufw allow 8881/tcp
sudo ufw allow 8882/tcp

# CentOS/RHEL (firewalld)
# sudo firewall-cmd --permanent --add-port=8880/tcp
# sudo firewall-cmd --permanent --add-port=8881/tcp
# sudo firewall-cmd --permanent --add-port=8882/tcp
# sudo firewall-cmd --reload

# ============================================
# 5. 构建并启动服务
# ============================================

# 构建Docker镜像
docker compose -f docker-compose.yml -f docker-compose.ip.yml build

# 启动所有服务
docker compose -f docker-compose.yml -f docker-compose.ip.yml up -d

# 查看服务状态
docker compose -f docker-compose.yml -f docker-compose.ip.yml ps

# 查看日志（等待服务启动完成）
docker compose -f docker-compose.yml -f docker-compose.ip.yml logs -f

# ============================================
# 6. 访问应用
# ============================================

echo "=========================================="
echo "部署完成！访问地址："
echo "  前端界面: http://${SERVER_IP}:8880"
echo "  API文档:  http://${SERVER_IP}:8881/docs"
echo "  API地址:  http://${SERVER_IP}:8881"
echo "  数据库管理: http://${SERVER_IP}:8882"
echo "=========================================="
```

---

## 分步执行（推荐）

### 步骤1: 安装Docker

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y
sudo apt-get install -y ca-certificates curl gnupg lsb-release
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
sudo docker --version
sudo docker compose version
```

### 步骤2: 准备项目

```bash
# 创建目录
mkdir -p /root/code
cd /root/code

# 如果使用Git克隆
# git clone your-repository-url pminfo
# cd pminfo

# 如果项目已上传，直接进入
# cd /root/code/pminfo
```

### 步骤3: 配置环境变量

```bash
# 获取服务器IP
SERVER_IP=$(hostname -I | awk '{print $1}')
echo "服务器IP: $SERVER_IP"

# 生成密钥
SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_urlsafe(32))")
DB_PASSWORD=$(python3 -c "import secrets; print(secrets.token_urlsafe(32))")

# 创建.env文件
cat > .env << EOF
ENVIRONMENT=production
DOMAIN=localhost
STACK_NAME=pminfo
PROJECT_NAME=PMinfo
DOCKER_IMAGE_BACKEND=pminfo-backend
DOCKER_IMAGE_FRONTEND=pminfo-frontend
TAG=latest
PUBLIC_HOST=${SERVER_IP}
FRONTEND_HOST=http://${SERVER_IP}:8880
BACKEND_CORS_ORIGINS=["http://${SERVER_IP}:8880"]
SECRET_KEY=${SECRET_KEY}
FIRST_SUPERUSER=admin@example.com
FIRST_SUPERUSER_PASSWORD=changethis
POSTGRES_SERVER=db
POSTGRES_PORT=5432
POSTGRES_USER=app
POSTGRES_PASSWORD=${DB_PASSWORD}
POSTGRES_DB=app
SMTP_HOST=
SMTP_USER=
SMTP_PASSWORD=
SMTP_PORT=587
SMTP_TLS=true
EMAILS_FROM_EMAIL=noreply@example.com
SENTRY_DSN=
EOF

# 编辑.env文件，修改管理员信息
nano .env
```

### 步骤4: 开放防火墙端口

```bash
# Ubuntu/Debian
sudo ufw allow 8880/tcp
sudo ufw allow 8881/tcp
sudo ufw allow 8882/tcp

# 或者关闭防火墙（仅测试环境）
# sudo ufw disable
```

### 步骤5: 构建和启动

```bash
# 构建镜像
docker compose -f docker-compose.yml -f docker-compose.ip.yml build

# 启动服务
docker compose -f docker-compose.yml -f docker-compose.ip.yml up -d

# 查看状态
docker compose -f docker-compose.yml -f docker-compose.ip.yml ps

# 查看日志
docker compose -f docker-compose.yml -f docker-compose.ip.yml logs -f
```

---

## 常用管理命令

### 查看服务状态

```bash
docker compose -f docker-compose.yml -f docker-compose.ip.yml ps
```

### 查看日志

```bash
# 所有服务
docker compose -f docker-compose.yml -f docker-compose.ip.yml logs -f

# 特定服务
docker compose -f docker-compose.yml -f docker-compose.ip.yml logs -f backend
docker compose -f docker-compose.yml -f docker-compose.ip.yml logs -f frontend
docker compose -f docker-compose.yml -f docker-compose.ip.yml logs -f db
```

### 重启服务

```bash
# 所有服务
docker compose -f docker-compose.yml -f docker-compose.ip.yml restart

# 特定服务
docker compose -f docker-compose.yml -f docker-compose.ip.yml restart backend
```

### 停止服务

```bash
# 停止（保留数据）
docker compose -f docker-compose.yml -f docker-compose.ip.yml down

# 停止并删除数据（谨慎！）
docker compose -f docker-compose.yml -f docker-compose.ip.yml down -v
```

### 更新应用

```bash
# 拉取最新代码
git pull

# 重新构建并启动
docker compose -f docker-compose.yml -f docker-compose.ip.yml build
docker compose -f docker-compose.yml -f docker-compose.ip.yml up -d

# 运行数据库迁移
docker compose -f docker-compose.yml -f docker-compose.ip.yml exec backend uv run alembic upgrade head
```

---

## 端口说明

| 服务 | 主机端口 | 容器端口 | 访问地址 |
|------|---------|---------|---------|
| 前端 | 8880 | 80 | http://IP:8880 |
| 后端API | 8881 | 8000 | http://IP:8881 |
| Adminer | 8882 | 8080 | http://IP:8882 |
| PostgreSQL | - | 5432 | 仅内部使用 |

---

## 注意事项

1. **修改管理员密码**: 部署后立即修改 `.env` 中的 `FIRST_SUPERUSER_PASSWORD`
2. **防火墙**: 确保防火墙开放 8880、8881、8882 端口
3. **首次启动**: 首次启动可能需要几分钟，等待数据库初始化和迁移完成
4. **查看日志**: 如果无法访问，使用 `docker compose logs` 查看错误信息

---

## 故障排查

### 端口被占用

```bash
# 检查端口占用
netstat -tulpn | grep -E ':(8880|8881|8882)'

# 或修改 docker-compose.ip.yml 中的端口映射
```

### 服务无法启动

```bash
# 查看错误日志
docker compose -f docker-compose.yml -f docker-compose.ip.yml logs

# 检查环境变量
cat .env
```

### 前端无法连接后端

```bash
# 检查后端服务
docker compose -f docker-compose.yml -f docker-compose.ip.yml logs backend

# 确保.env中的PUBLIC_HOST、FRONTEND_HOST、BACKEND_CORS_ORIGINS配置正确
```

