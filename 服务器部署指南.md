# PMinfo 系统服务器部署指南

本指南将帮助您在服务器上部署 PMinfo 系统（FastAPI + React 全栈应用）。

## 📋 目录

1. [前置要求](#前置要求)
2. [服务器准备](#服务器准备)
3. [配置域名和DNS](#配置域名和dns)
4. [安装Docker](#安装docker)
5. [部署Traefik反向代理](#部署traefik反向代理)
6. [部署应用](#部署应用)
7. [验证部署](#验证部署)
8. [常见问题](#常见问题)

---

## 前置要求

- 一台可访问的服务器（Linux系统，推荐Ubuntu 20.04+）
- 一个域名（用于HTTPS证书）
- 服务器root或sudo权限
- 基本的Linux命令行操作知识

---

## 服务器准备

### 1. 连接到服务器

```bash
ssh root@your-server-ip
# 或
ssh your-username@your-server-ip
```

### 2. 更新系统

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

---

## 配置域名和DNS

### 1. 配置DNS记录

在您的域名DNS管理面板中添加以下记录：

- **A记录**: `*.yourdomain.com` → 指向服务器IP地址
- **A记录**: `yourdomain.com` → 指向服务器IP地址

例如：
- `*.pminfo.example.com` → `123.45.67.89`
- `pminfo.example.com` → `123.45.67.89`

这将允许访问：
- `dashboard.pminfo.example.com` (前端)
- `api.pminfo.example.com` (后端API)
- `traefik.pminfo.example.com` (Traefik管理面板)
- `adminer.pminfo.example.com` (数据库管理)

### 2. 等待DNS传播

DNS记录生效可能需要几分钟到几小时，可以使用以下命令检查：

```bash
dig yourdomain.com
# 或
nslookup yourdomain.com
```

---

## 安装Docker

### Ubuntu/Debian

```bash
# 卸载旧版本（如果有）
sudo apt-get remove docker docker-engine docker.io containerd runc

# 安装依赖
sudo apt-get update
sudo apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# 添加Docker官方GPG密钥
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 设置仓库
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装Docker Engine
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 验证安装
sudo docker --version
sudo docker compose version
```

### CentOS/RHEL

```bash
# 安装依赖
sudo yum install -y yum-utils

# 添加Docker仓库
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# 安装Docker
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# 启动Docker
sudo systemctl start docker
sudo systemctl enable docker

# 验证安装
sudo docker --version
sudo docker compose version
```

---

## 部署Traefik反向代理

Traefik将处理HTTPS证书和反向代理。

### 1. 创建Traefik目录

```bash
mkdir -p /root/code/traefik-public
cd /root/code/traefik-public
```

### 2. 上传Traefik配置文件

将项目中的 `docker-compose.traefik.yml` 文件上传到服务器：

```bash
# 方法1: 使用scp从本地上传
scp docker-compose.traefik.yml root@your-server-ip:/root/code/traefik-public/

# 方法2: 直接在服务器上创建文件
nano /root/code/traefik-public/docker-compose.traefik.yml
# 然后复制项目中的 docker-compose.traefik.yml 内容
```

### 3. 创建Docker网络

```bash
docker network create traefik-public
```

### 4. 配置Traefik环境变量

```bash
cd /root/code/traefik-public

# 设置Traefik管理面板的用户名和密码
export USERNAME=admin
export PASSWORD=your-secure-password-here

# 生成密码哈希
export HASHED_PASSWORD=$(openssl passwd -apr1 $PASSWORD)

# 设置域名（替换为您的实际域名）
export DOMAIN=pminfo.example.com

# 设置Let's Encrypt邮箱（必须使用真实邮箱）
export EMAIL=your-email@example.com
```

**重要**: 
- `PASSWORD` 请使用强密码
- `DOMAIN` 替换为您的实际域名
- `EMAIL` 必须使用真实邮箱，用于Let's Encrypt证书通知

### 5. 启动Traefik

```bash
docker compose -f docker-compose.traefik.yml up -d
```

### 6. 验证Traefik运行

```bash
# 查看容器状态
docker ps | grep traefik

# 查看日志
docker compose -f docker-compose.traefik.yml logs -f
```

访问 `https://traefik.yourdomain.com` 应该能看到Traefik管理面板（需要输入用户名和密码）。

---

## 部署应用

### 1. 上传项目代码

```bash
# 方法1: 使用Git克隆（推荐）
cd /root/code
git clone your-repository-url pminfo
cd pminfo

# 方法2: 使用scp上传整个项目目录
# 在本地执行：
# scp -r /path/to/full-stack-fastapi-template root@your-server-ip:/root/code/pminfo
```

### 2. 创建.env文件

```bash
cd /root/code/pminfo

# 如果项目中有 .env.example，可以复制它
# cp .env.example .env

# 创建.env文件
nano .env
```

在 `.env` 文件中配置以下内容（**重要：请修改所有默认值**）：

```env
# 环境配置
ENVIRONMENT=production
DOMAIN=pminfo.example.com
STACK_NAME=pminfo-example-com

# 项目配置
PROJECT_NAME=PMinfo
DOCKER_IMAGE_BACKEND=pminfo-backend
DOCKER_IMAGE_FRONTEND=pminfo-frontend
TAG=latest

# 前端配置
FRONTEND_HOST=https://dashboard.pminfo.example.com
BACKEND_CORS_ORIGINS=["https://dashboard.pminfo.example.com","https://api.pminfo.example.com"]

# 安全密钥（必须修改！）
# 生成密钥命令: python -c "import secrets; print(secrets.token_urlsafe(32))"
SECRET_KEY=your-generated-secret-key-here

# 超级用户配置（第一个管理员账户）
FIRST_SUPERUSER=admin@example.com
FIRST_SUPERUSER_PASSWORD=your-secure-password-here

# 数据库配置
POSTGRES_SERVER=db
POSTGRES_PORT=5432
POSTGRES_USER=app
POSTGRES_PASSWORD=your-database-password-here
POSTGRES_DB=app

# 邮件配置（可选，用于密码重置等功能）
SMTP_HOST=
SMTP_USER=
SMTP_PASSWORD=
SMTP_PORT=587
SMTP_TLS=true
EMAILS_FROM_EMAIL=noreply@example.com

# Sentry配置（可选，用于错误监控）
SENTRY_DSN=
```

**重要提示**：
1. 使用以下命令生成安全的密钥：
   ```bash
   python3 -c "import secrets; print(secrets.token_urlsafe(32))"
   ```
   将生成的密钥用于 `SECRET_KEY` 和 `POSTGRES_PASSWORD`

2. 修改所有包含 `changethis` 或 `example.com` 的值

3. `DOMAIN` 必须与Traefik配置中的域名一致

### 3. 构建和启动应用

```bash
cd /root/code/pminfo

# 设置必要的环境变量
export DOMAIN=pminfo.example.com
export STACK_NAME=pminfo-example-com
export TAG=latest

# 构建Docker镜像
docker compose -f docker-compose.yml build

# 启动所有服务
docker compose -f docker-compose.yml up -d

# 查看服务状态
docker compose ps

# 查看日志
docker compose logs -f
```

### 4. 等待服务启动

首次启动可能需要几分钟时间，因为需要：
- 下载Docker镜像
- 构建应用镜像
- 初始化数据库
- 运行数据库迁移

可以使用以下命令监控启动过程：

```bash
# 查看所有服务日志
docker compose logs -f

# 查看特定服务日志
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f db
```

---

## 验证部署

### 1. 检查服务状态

```bash
cd /root/code/pminfo
docker compose ps
```

所有服务应该显示为 `Up` 状态。

### 2. 访问应用

在浏览器中访问以下URL（替换为您的实际域名）：

- **前端界面**: `https://dashboard.pminfo.example.com`
- **API文档**: `https://api.pminfo.example.com/docs`
- **API基础URL**: `https://api.pminfo.example.com`
- **数据库管理**: `https://adminer.pminfo.example.com`
- **Traefik面板**: `https://traefik.pminfo.example.com`

### 3. 测试登录

使用 `.env` 文件中配置的 `FIRST_SUPERUSER` 和 `FIRST_SUPERUSER_PASSWORD` 登录系统。

### 4. 检查HTTPS证书

访问应用时，浏览器地址栏应该显示绿色的锁图标，表示HTTPS证书已正确配置。

---

## 常见问题

### 问题1: 服务无法启动

**检查步骤**：
```bash
# 查看所有服务状态
docker compose ps

# 查看错误日志
docker compose logs

# 检查是否有端口冲突
netstat -tulpn | grep -E ':(80|443|5432)'
```

**常见原因**：
- 端口被占用
- 环境变量未正确设置
- Docker网络问题

### 问题2: HTTPS证书获取失败

**检查步骤**：
```bash
# 检查Traefik日志
cd /root/code/traefik-public
docker compose logs traefik

# 检查DNS解析
dig dashboard.yourdomain.com
```

**常见原因**：
- DNS记录未正确配置
- 域名未指向服务器IP
- 防火墙阻止了80和443端口

**解决方案**：
```bash
# 确保防火墙开放端口
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

### 问题3: 前端无法连接后端

**检查步骤**：
```bash
# 检查后端服务
docker compose logs backend

# 检查CORS配置
# 确保 .env 中的 BACKEND_CORS_ORIGINS 包含前端域名
```

**解决方案**：
确保 `.env` 文件中的 `BACKEND_CORS_ORIGINS` 包含前端URL：
```env
BACKEND_CORS_ORIGINS=["https://dashboard.pminfo.example.com"]
```

### 问题4: 数据库连接失败

**检查步骤**：
```bash
# 检查数据库服务
docker compose logs db

# 测试数据库连接
docker compose exec db psql -U app -d app
```

**解决方案**：
- 确保 `.env` 中的数据库密码正确
- 等待数据库完全启动（首次启动可能需要30秒）

### 问题5: 更新应用

```bash
cd /root/code/pminfo

# 拉取最新代码
git pull

# 重新构建并启动
docker compose -f docker-compose.yml build
docker compose -f docker-compose.yml up -d

# 运行数据库迁移（如果需要）
docker compose exec backend uv run alembic upgrade head
```

### 问题6: 查看实时日志

```bash
# 查看所有服务日志
docker compose logs -f

# 查看特定服务日志
docker compose logs -f backend
docker compose logs -f frontend
```

### 问题7: 重启服务

```bash
# 重启所有服务
docker compose restart

# 重启特定服务
docker compose restart backend
docker compose restart frontend
```

### 问题8: 停止和清理

```bash
# 停止所有服务（保留数据）
docker compose down

# 停止并删除所有数据（谨慎使用！）
docker compose down -v
```

---

## 维护和备份

### 数据库备份

项目已包含备份脚本，可以定期备份数据库：

```bash
cd /root/code/pminfo
./scripts/backup-database.sh
```

### 设置自动备份

```bash
# 编辑crontab
crontab -e

# 添加每天凌晨2点备份（示例）
0 2 * * * cd /root/code/pminfo && ./scripts/backup-database.sh >> /var/log/pminfo-backup.log 2>&1
```

### 监控服务

建议设置监控来确保服务正常运行：

```bash
# 检查服务健康状态
docker compose ps

# 检查资源使用
docker stats
```

---

## 安全建议

1. **修改默认密码**: 确保所有默认密码都已更改
2. **使用强密钥**: 使用 `secrets.token_urlsafe(32)` 生成强密钥
3. **定期更新**: 定期更新系统和Docker镜像
4. **防火墙配置**: 只开放必要的端口（80, 443）
5. **备份数据**: 定期备份数据库
6. **日志监控**: 定期检查日志，发现异常活动

---

## 获取帮助

如果遇到问题：

1. 查看日志：`docker compose logs`
2. 检查服务状态：`docker compose ps`
3. 参考项目文档：`deployment.md` 和 `DEPLOYMENT_GUIDE.md`
4. 检查GitHub Issues

---

## 下一步

部署成功后，您可以：

1. 配置邮件服务（用于密码重置等功能）
2. 设置Sentry错误监控
3. 配置CI/CD自动部署
4. 设置定期备份任务
5. 配置监控和告警

祝您部署顺利！🎉

